---
- name: Include OS-specific variables
  include_vars: "{{ item }}"
  with_items:
    - "{{ ansible_distribution_release }}.yml"
    - "common.yml"

- name: Disable unattended upgrades
  copy:
    content: 'APT::Periodic::Unattended-Upgrade "0";'
    dest: "{{ item }}"
  with_items:
    - /etc/apt/apt.conf.d/10periodic
    - /etc/apt/apt.conf.d/20auto-upgrades

- name: Add Nectar archive keys
  apt_key:
    id: ABC968C25CDB0CDD6254F46A129CF4A68FA8FC77
    url: http://download.rc.nectar.org.au/nectar-archive-key-2016.gpg
    state: present

- name: Add Nectar repositories
  apt_repository:
    repo: "{{ item }}"
    update_cache: yes
  with_items:
    - "deb http://download.rc.nectar.org.au/nectar-ubuntu {{ ansible_distribution_release }} main"
    - "deb http://download.rc.nectar.org.au/nectar-ubuntu {{ ansible_distribution_release }}-{{ openstack_version }} main"
    - "deb http://download.rc.nectar.org.au/nectar-ubuntu {{ ansible_distribution_release }}-{{ openstack_version }}-testing main"
  when: openstack_version is defined

- name: Add Puppet Key
  apt_key:
    keyserver: keyserver.ubuntu.com
    id: D6811ED3ADEEB8441AF5AA8F4528B6CD9E61EF26

- name: Add Puppet Repo
  apt_repository:
    repo: "{{ puppet_repo }}"
    update_cache: yes
  when: puppet_repo is defined

- name: Add NodeJS repo key
  apt_key:
    url: http://deb.nodesource.com/gpgkey/nodesource.gpg.key
    state: present
  when: nodejs_repo is defined

- name: Add NodeJS repo
  apt_repository:
    repo: "deb https://deb.nodesource.com/{{ nodejs_repo }} {{ ansible_distribution_release }} main"
    update_cache: yes
    filename: nodejs
  when: nodejs_repo is defined

- name: Add ansible PPA
  apt_repository:
    repo: 'ppa:ansible/ansible-5'
  when: ansible_ppa is defined and ansible_ppa == True

# Remove once we no longer install python2 and python3 version of cinderclient
- name: Diversion for python2/python3-cinderclient conflict
  command:
    cmd: dpkg-divert --quiet --package python-cinderclient --divert /usr/share/bash-completion/completions/python2-cinder.bash_completion --rename /usr/share/bash-completion/completions/cinder.bash_completion
    creates: /usr/share/bash-completion/completions/python2-cinder.bash_completion

- name: Perform an apt-update
  apt:
    update_cache: yes

- name: Install common packages
  apt:
    name: "{{ common_packages }}"
    state: present

- name: Install distrubution specific packages
  apt:
    name: "{{ packages }}"
    state: present
  when: packages is defined

- name: Install distrubution specific backport packages
  apt:
    name: "{{ backport_packages }}"
    state: latest
    default_release: "{{ ansible_distribution_release }}-backports"
  when: backport_packages is defined

- name: Install pip packages
  pip:
    name: "{{ item.name }}"
    version: "{{ item.version }}"
  with_items: "{{ pip_packages }}"
  when: pip_packages is defined

- name: Update pip for Hivemind in a python2 environment
  pip:
    virtualenv: /opt/hivemind
    virtualenv_python: python2.7
    name: pip
    state: latest
  when: hivemind_env is defined and hivemind_env == True

- name: Install Hivemind in a python2 environment
  pip:
     virtualenv: /opt/hivemind
     virtualenv_python: python2.7
     name: git+https://github.com/NeCTAR-RC/hivemind.git,git+https://github.com/NeCTAR-RC/hivemind_contrib.git
  when: hivemind_env is defined and hivemind_env == True

- name: Create a symbolic link for Hivemind python2 environment
  file:
    src: /opt/hivemind/bin/hivemind
    dest: /usr/local/bin/hivemind
    owner: root
    group: root
    state: link
  when: hivemind_env is defined and hivemind_env == True

- name: Install packer
  unarchive:
    src: "https://releases.hashicorp.com/packer/{{ packer_version }}/packer_{{ packer_version }}_linux_amd64.zip"
    dest: /usr/local/bin/
    remote_src: True

- name: Install gem packages
  gem:
    name: "{{ item }}"
    state: present
    user_install: no
  with_items: "{{ gem_packages }}"
  when: gem_packages is defined

- name: Perform a full upgrade
  apt:
    upgrade: dist
    dpkg_options: 'force-confold,force-confdef'
  when: nectar_test_build is not defined

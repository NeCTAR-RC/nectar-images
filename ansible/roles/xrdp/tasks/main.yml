---
- name: Include OS-specific variables
  include_vars: "{{ item }}"
  with_first_found:
    - "{{ ansible_distribution }}_{{ ansible_distribution_version }}.yml"
    - "{{ ansible_distribution }}_{{ ansible_distribution_major_version }}.yml"
    - "{{ ansible_distribution }}_{{ ansible_distribution_release }}.yml"
    - "{{ ansible_distribution }}.yml"
    - "{{ ansible_os_family }}.yml"

- name: Install XRDP
  package:
    name: '{{ xrdp_packages }}'
    state: present

# Without this, TLS negotiation fails as the XRDP user is unable to read
# the self-signed cert/key
- name: Adding xrdp user to the ssl-cert group
  user:
    name: xrdp
    groups: ssl-cert
    append: yes
  when: ansible_distribution == 'Ubuntu'

- name: Allow non-root users to login with xwrapper
  shell: 'echo "xserver-xorg-legacy xserver-xorg-legacy/xwrapper/allowed_users select Anybody" | debconf-set-selections'
  when: ansible_distribution == 'Ubuntu'

- name: Add XRDP config files
  template:
    src: "{{ item }}.j2"
    dest: "/etc/xrdp/{{ item }}"
  with_items:
    - xrdp.ini
    - sesman.ini
  notify:
    - restart xrdp
    - restart sesman

- name: Enable XRDP and sesman services
  service:
    name: "{{ item }}"
    enabled: yes
  with_items:
    - xrdp
    - xrdp-sesman

# Fix for GNOME keyring
- include_tasks: keyring.yml

- include_tasks: pulseaudio.yml
  when: pulseaudio_modules_dir is defined

- include_tasks: pipewire.yml
  when: pipewire_modules_dir is defined

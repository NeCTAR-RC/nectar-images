---
# Ensure Pipewire replaces Pipewire for Rocky9 at least
- name: Install pipewire
  ansible.builtin.dnf:
    name: pipewire
    state: present
    allowerasing: true
  when: ansible_os_family == 'RedHat'

# Ensure Pipewire is installed on Ubuntu
- name: Install pipewire
  ansible.builtin.apt:
    name: pipewire
    state: present
  when: ansible_os_family == 'Debian'

# To build, follow the instructions from
#  https://github.com/neutrinolabs/pipewire-module-xrdp/wiki/README
- name: Install XRDP Pipewire modules
  copy:
    src: "xrdp-pipewire/{{ pipewire_files_dir }}/{{ item }}"
    dest: "{{ pipewire_modules_dir }}/{{ item }}"
  with_items:
    - libpipewire-module-xrdp.la
    - libpipewire-module-xrdp.so

- name: Install pipewire-xrdp.desktop
  copy:
    src: "xrdp-pipewire/{{ pipewire_files_dir }}/pipewire-xrdp.desktop"
    dest: /etc/xdg/autostart/pipewire-xrdp.desktop

- name: Create xrdp-pipewire-installer directory
  file:
    path: /libexec/pipewire-module-xrdp
    state: directory

- name: Install load_pw_modules.sh
  copy:
    src: "xrdp-pipewire/{{ pipewire_files_dir }}/load_pw_modules.sh"
    dest: /libexec/pipewire-module-xrdp/load_pw_modules.sh
    mode: '0755'

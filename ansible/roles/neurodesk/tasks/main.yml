---
- name: Include OS-specific variables
  ansible.builtin.include_vars: "{{ item }}"
  with_first_found:
    - "{{ ansible_distribution | lower }}.yml"
    - "{{ ansible_os_family | lower }}.yml"
    - "default.yml"

- name: Install extra packages
  ansible.builtin.package:
    name: "{{ neurodesk_extra_packages }}"
    state: present

- name: Create directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  with_items:
    - /data
    - /opt/neurodesktop
    - /etc/jupyter
    - /etc/skel/.config/lxpanel
    - /etc/skel/.config/lxpanel/LXDE
    - /etc/skel/.config/lxpanel/LXDE/panels
    - /etc/skel/.config/Code/User

- name: Copy config files
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "0644"
  with_items:
    - src: config/lxde/background.png
      dest: /usr/share/lxde/wallpapers/desktop_wallpaper.png
    - src: config/lxde/pcmanfm.conf
      dest: /etc/xdg/pcmanfm/LXDE/pcmanfm.conf
    - src: config/lxde/lxterminal.conf
      dest: /usr/share/lxterminal/lxterminal.conf
    - src: config/lxde/panel
      dest: /etc/skel/.config/lxpanel/LXDE/panels/panel
    - src: config/lxde/libfm.conf
      dest: /etc/skel/.config/libfm
    - src: config/lxde/rc.xml
      dest: /etc/xdg/openbox/LXDE/rc.xml
    # bashrc - breaks lots of things, so Andy disabled
    # - src: config/lxde/.bashrc
    #   dest: /etc/skel/.bashrc
    - src: config/neurodesktop.sh
      dest: /etc/profile.d/neurodesktop.sh
    # mineapps
    - src: config/lxde/mimeapps.list
      dest: /etc/skel/.config/mimeapps.list
    # misc
    - src: config/test_neurodesktop.sh
      dest: /usr/share/test_neurodesktop.sh
    - src: config/itksnap
      dest: /etc/skel/.config/.itksnap.org
    # VSCode
    - src: config/vscode/settings.json
      dest: /etc/skel/.config/Code/User/settings.json

- name: Copy module system
  ansible.builtin.copy:
    src: config/lmod/module.sh
    dest: /usr/share/
    mode: "0755"

- name: Create storage directory
  ansible.builtin.file:
    path: /neurodesktop-storage
    state: directory
    mode: "0777"

- name: Create storage directory
  ansible.builtin.file:
    path: /etc/skel/Desktop
    state: directory
    mode: "0755"

- name: Create a symbolic link to upload directory (has to be forced because home does not yet exist at buildtime)
  ansible.builtin.file:
    src: /neurodesktop-storage
    dest: /etc/skel/Desktop/neurodesktop-storage
    state: link

- name: Create a symbolic link
  ansible.builtin.file:
    src: /home/vdiuser/thinclient_drives/GUACFS
    dest: /etc/skel/Desktop/transfer
    state: link
    force: true
    follow: false

# TODO(andybotting): Not needed outside a container?
# Allow the root user to access the sshfs mount
# https://github.com/neurodesk/neurodesk/issues/47
- name: Ensure SELinux is set to enforcing mode
  ansible.builtin.lineinfile:
    path: /etc/fuse.conf
    regexp: "#user_allow_other"
    line: "user_allow_other"

- name: Include globus
  ansible.builtin.include_tasks: globus.yml

- name: Include CVMFS
  ansible.builtin.include_tasks: cvmfs.yml

- name: Include Apptainer
  ansible.builtin.include_tasks: apptainer.yml

- name: Include Julia
  ansible.builtin.include_tasks: julia.yml

- name: Include Conda
  ansible.builtin.include_tasks: conda.yml

- name: Include Jupyter
  ansible.builtin.include_tasks: jupyter.yml

- name: Include NeuroCommand
  ansible.builtin.include_tasks: neurocommand.yml

- name: Clone NeuroDesk example-notebooks
  ansible.builtin.git:
    repo: https://github.com/neurodesk/example-notebooks
    dest: /etc/skel/example-notebooks
    version: main
    depth: 1

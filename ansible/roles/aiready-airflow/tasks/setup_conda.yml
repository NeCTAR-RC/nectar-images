---
- name: Create Airflow directory structure
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ airflow_home }}"
    - "{{ airflow_home }}/dags"
    - "{{ airflow_home }}/logs"
    - "{{ airflow_home }}/plugins"

- name: Copy example notebooks to JupyterLab directory
  copy:
    src: "{{ item }}"
    dest: "{{ airflow_notebook_directory }}/"
    mode: "0644"
  with_fileglob:
    - "notebooks/*.ipynb"

- name: Copy example DAGs to Airflow directory
  copy:
    src: "{{ item }}"
    dest: "{{ airflow_home }}/dags"
    mode: "0644"
  with_fileglob:
    - "*.py"

- name: Install Airflow with dependencies
  ansible.builtin.pip:
    executable: "{{ anaconda_link_dir }}/bin/pip"
    name:
      - "apache-airflow[postgres,spark,databricks]=={{ airflow_version }}"
      - psycopg2-binary
      - statsd
    state: present
  register: airflow_install
  changed_when: airflow_install.changed
